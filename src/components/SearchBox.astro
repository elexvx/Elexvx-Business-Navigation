---
import { searchEngines, searchConfig, getSearchEngine } from '../config/search';

const enabledEngines = searchEngines.filter(engine =>
  searchConfig.enabledEngines.includes(engine.name)
);
const defaultEngine = getSearchEngine(searchConfig.defaultEngine) || enabledEngines[0];
const searchEnginesData = Object.fromEntries(
  enabledEngines.map(engine => [engine.name, engine])
);
---

<div class="search-container relative">
  <div class="flex items-center bg-white rounded-xl border border-gray-200 shadow-sm hover:shadow-md transition-shadow duration-200">
    <!-- 搜索引擎选择器 -->
    {searchConfig.showEngineSelector && (
      <div class="relative">
        <button 
          id="engine-selector"
          class="flex items-center px-3 py-3 text-sm font-medium text-gray-700 hover:text-blue-600 border-r border-gray-200 rounded-l-xl hover:bg-gray-50 transition-colors duration-200"
          aria-label="选择搜索引擎"
        >
          <span class="mr-1 text-base" id="current-engine-icon">{defaultEngine.icon}</span>
          <span class="hidden sm:inline" id="current-engine-name">{defaultEngine.displayName}</span>
          <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
          </svg>
        </button>
        
        <!-- 下拉菜单 -->
        <div 
          id="engine-dropdown"
          class="absolute top-full left-0 mt-1 w-48 bg-white rounded-lg shadow-lg border border-gray-200 z-50 hidden"
        >
          {enabledEngines.map(engine => (
            <button
              class="engine-option w-full flex items-center px-4 py-3 text-sm text-gray-700 hover:bg-blue-50 hover:text-blue-600 transition-colors duration-200 first:rounded-t-lg last:rounded-b-lg"
              data-engine={engine.name}
              data-icon={engine.icon}
              data-display-name={engine.displayName}
              data-placeholder={engine.placeholder}
            >
              <span class="mr-3 text-base">{engine.icon}</span>
              <span>{engine.displayName}</span>
            </button>
          ))}
        </div>
      </div>
    )}
    
    <!-- 搜索输入框 -->
    <div class="flex-1 relative">
      <input
        type="text"
        id="search-input"
        placeholder={defaultEngine.placeholder}
        class="w-full px-4 py-3 text-gray-900 placeholder-gray-500 bg-transparent border-0 rounded-r-xl focus:outline-none focus:ring-0"
        autocomplete="off"
      />
      
      <!-- 搜索按钮 -->
      <button
        id="search-button"
        class="absolute right-2 top-1/2 transform -translate-y-1/2 p-2 text-gray-400 hover:text-blue-600 transition-colors duration-200"
        aria-label="搜索"
      >
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
        </svg>
      </button>
    </div>
  </div>
  
  <!-- 搜索建议（可选功能） -->
  <div 
    id="search-suggestions"
    class="absolute top-full left-0 right-0 mt-1 bg-white rounded-lg shadow-lg border border-gray-200 z-40 hidden"
  >
    <!-- 搜索建议将通过 JavaScript 动态填充 -->
  </div>
</div>

<script define:vars={{ searchEnginesData, defaultEngine: defaultEngine.name }}>

  let currentEngine = defaultEngine;
  
  // DOM 元素
  const engineSelector = document.getElementById('engine-selector');
  const engineDropdown = document.getElementById('engine-dropdown');
  const searchInput = document.getElementById('search-input');
  const searchButton = document.getElementById('search-button');
  const currentEngineIcon = document.getElementById('current-engine-icon');
  const currentEngineName = document.getElementById('current-engine-name');
  
  // 生成搜索 URL
  function generateSearchUrl(engine, query) {
    if (!query.trim()) return '#';
    const url = new URL(searchEnginesData[engine].baseUrl);
    url.searchParams.set(searchEnginesData[engine].queryParam, query.trim());
    return url.toString();
  }
  
  // 执行搜索
  function performSearch() {
    const query = searchInput?.value;
    if (query && query.trim()) {
      const searchUrl = generateSearchUrl(currentEngine, query);
      window.open(searchUrl, '_blank', 'noopener,noreferrer');
    }
  }
  
  // 切换搜索引擎
  function switchEngine(engineName) {
    if (searchEnginesData[engineName]) {
      currentEngine = engineName;
      const engine = searchEnginesData[engineName];
      
      if (currentEngineIcon) currentEngineIcon.textContent = engine.icon;
      if (currentEngineName) currentEngineName.textContent = engine.displayName;
      if (searchInput) searchInput.placeholder = engine.placeholder;
      
      // 保存用户偏好
      localStorage.setItem('preferred-search-engine', engineName);
    }
  }
  
  // 初始化
  function init() {
    // 恢复用户偏好的搜索引擎
    const savedEngine = localStorage.getItem('preferred-search-engine');
    if (savedEngine && searchEnginesData[savedEngine]) {
      switchEngine(savedEngine);
    }
    
    // 搜索引擎选择器事件
    engineSelector?.addEventListener('click', (e) => {
      e.stopPropagation();
      engineDropdown?.classList.toggle('hidden');
    });
    
    // 搜索引擎选项事件
    document.querySelectorAll('.engine-option').forEach(option => {
      option.addEventListener('click', (e) => {
        const engineName = e.currentTarget.dataset.engine;
        switchEngine(engineName);
        engineDropdown?.classList.add('hidden');
      });
    });
    
    // 搜索按钮事件
    searchButton?.addEventListener('click', performSearch);
    
    // 回车键搜索
    searchInput?.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        performSearch();
      }
    });
    
    // 点击外部关闭下拉菜单
    document.addEventListener('click', (e) => {
      if (!engineSelector?.contains(e.target) && !engineDropdown?.contains(e.target)) {
        engineDropdown?.classList.add('hidden');
      }
    });
    
    // ESC 键关闭下拉菜单
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        engineDropdown?.classList.add('hidden');
      }
    });
  }
  
  // 页面加载完成后初始化
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
</script>

<style>
  .search-container {
    max-width: 600px;
  }
  
  /* 搜索输入框焦点样式 */
  #search-input:focus {
    outline: none;
  }
  
  .search-container:focus-within {
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
  }
  
  /* 下拉菜单动画 */
  #engine-dropdown {
    animation: fadeIn 0.15s ease-out;
  }
  
  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(-4px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  
  /* 响应式调整 */
  @media (max-width: 640px) {
    #engine-dropdown {
      width: 200px;
    }
  }
</style>